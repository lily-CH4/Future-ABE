<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABELE Quiz Engine Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js for parsing PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e',
                        primaryHover: '#0d9488',
                        secondary: '#1e293b',
                        accent: '#f59e0b',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkText: '#f1f5f9',
                        darkSubText: '#94a3b8',
                        darkBorder: '#334155',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'spin-slow': 'spin 1.5s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        html.dark ::-webkit-scrollbar-track { background: #1e293b; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .screen { animation: fadeIn 0.3s ease-out; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { transform: translateX(100%); transition: transform 0.3s ease-out; }
        .toast.show { transform: translateX(0); }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #0f766e; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
        html.dark input[type=range]::-webkit-slider-thumb { background: #34d399; }
        html.dark input[type=range]::-webkit-slider-runnable-track { background: #334155; }

        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .listen-text { font-size: 1.125rem; line-height: 1.75rem; padding: 0 !important; }

        .speech-bubble { position: relative; padding: 1rem 1.25rem; border-radius: 1rem; background-color: #ffffff; border: 1px solid #cbd5e1; }
        .speech-bubble::before { content: ''; position: absolute; bottom: 50%; left: -16px; width: 0; height: 0; border: 8px solid transparent; border-right-color: #cbd5e1; border-bottom: 8px solid #cbd5e1; transform: translateY(50%); }
        .speech-bubble::after { content: ''; position: absolute; bottom: 50%; left: -14px; width: 0; height: 0; border: 7px solid transparent; border-right-color: #ffffff; border-bottom: 7px solid #ffffff; transform: translateY(50%); z-index: 1; }
        html.dark .speech-bubble { border: 1px solid #475569; }
        html.dark .speech-bubble::before { border-right-color: #475569; border-bottom: 8px solid #475569; }
        #progressBar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-slate-800 font-sans dark:bg-darkBg dark:text-darkText transition-colors duration-300">

    <div id="toast-container" class="flex flex-col gap-2"></div>

    <!-- AI Settings Modal -->
    <div id="aiSettingsModal" class="modal-backdrop hidden">
        <div class="bg-white dark:bg-darkCard rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-darkText text-slate-800">AI Settings</h3>
            
            <div class="space-y-4">
                <!-- API Key Input (New) -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-darkSubText mb-2">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="Paste your API Key here" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:text-darkText dark:border-slate-600 text-sm">
                    <p class="text-xs text-slate-500 mt-1">Required for AI Generator & Explanations. Key is saved locally.</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-darkSubText mb-2">Learning Style</label>
                    <div class="flex space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                        <button data-style="formal" onclick="selectAiStyle('formal')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium ai-style-btn text-slate-500 transition-colors duration-200">Formal</button>
                        <button data-style="simplified" onclick="selectAiStyle('simplified')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium ai-style-btn text-slate-500 transition-colors duration-200">Simplified</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-darkSubText mb-2">Language</label>
                    <div class="flex space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                        <button data-lang="en" onclick="selectAiLanguage('en')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium ai-lang-btn text-slate-500 transition-colors duration-200">English</button>
                        <button data-lang="taglish" onclick="selectAiLanguage('taglish')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium ai-lang-btn text-slate-500 transition-colors duration-200">Taglish</button>
                    </div>
                </div>
            </div>
            <button onclick="saveAiSettings()" class="w-full mt-6 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 font-bold">Save & Close</button>
        </div>
    </div>
    
    <div class="lg:hidden bg-primary text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-40">
        <div class="font-bold text-xl">ABELE Pro</div>
        <button id="mobileMenuBtn" class="text-white focus:outline-none">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <nav id="sidebar" class="bg-secondary text-white w-full lg:w-64 flex-shrink-0 hidden lg:flex flex-col h-screen sticky top-0 transition-all duration-300 z-30">
            <div class="p-4 border-b border-slate-600 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-emerald-400">ABELE<span class="text-white text-sm block font-normal mt-1">Quiz Engine Pro</span></h1>
                <button onclick="toggleDarkMode()" class="text-white hover:text-emerald-400 p-2 rounded-full transition duration-200">
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto py-4">
                <div class="px-4 space-y-2">
                    <button onclick="switchToScreen('homeTab')" id="homeTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600 bg-emerald-600"><span>üè†</span> <span>Home</span></button>
                    <button onclick="switchToScreen('topicsTab')" id="topicsTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>üìÅ</span> <span>Topics</span></button>
                    <button onclick="switchToScreen('questionsTab')" id="questionsTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>‚ùì</span> <span>Questions</span></button>
                    <button onclick="switchToScreen('generatorTab')" id="generatorTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600 text-amber-400"><span>‚ú®</span> <span>AI Generator</span></button>
                    <button onclick="switchToScreen('listenTab')" id="listenTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>üéß</span> <span>Listen Mode</span></button>
                    <button onclick="switchToScreen('quizTab')" id="quizTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>‚ö°</span> <span>Quick Quiz</span></button>
                    <button onclick="switchToScreen('focusTab')" id="focusTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>‚è∞</span> <span>Focus & Tasks</span></button>
                    <button onclick="switchToScreen('aboutTab')" id="aboutTab" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 hover:bg-slate-600"><span>‚ÑπÔ∏è</span> <span>About</span></button>
                </div>
            </div>
            <div class="p-4 border-t border-slate-600 text-xs text-slate-400 text-center uppercase font-bold">AREA 1, 2, 3 Mastery</div>
        </nav>

        <main class="flex-1 p-4 lg:p-8 overflow-x-hidden">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen animate-fade-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-darkText">Dashboard</h2>
                    <p class="text-slate-500 dark:text-darkSubText">Welcome back to ABELE Quiz Engine Pro.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder p-6 flex items-center space-x-4">
                        <div class="bg-emerald-100 p-3 rounded-full text-emerald-600 text-xl dark:bg-slate-700">üìö</div>
                        <div><div class="text-2xl font-bold dark:text-darkText" id="totalTopicsCount">0</div><div class="text-sm text-slate-500">Topics</div></div>
                    </div>
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder p-6 flex items-center space-x-4">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600 text-xl dark:bg-slate-700">üìë</div>
                        <div><div class="text-2xl font-bold dark:text-darkText" id="totalSubtopicsCount">0</div><div class="text-sm text-slate-500">Subtopics</div></div>
                    </div>
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder p-6 flex items-center space-x-4">
                        <div class="bg-amber-100 p-3 rounded-full text-amber-600 text-xl dark:bg-slate-700">‚ùì</div>
                        <div><div class="text-2xl font-bold dark:text-darkText" id="totalQuestionCount">0</div><div class="text-sm text-slate-500">Questions</div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder p-6">
                        <h3 class="text-lg font-bold mb-4 dark:text-darkText">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="switchToScreen('generatorTab')" class="bg-amber-100 hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-400 text-amber-800 font-semibold py-4 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition">
                                <span class="text-2xl">‚ú®</span> AI Generator
                            </button>
                            <button onclick="switchToScreen('questionsTab')" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:text-darkText font-semibold py-4 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition">
                                <span class="text-2xl">‚ûï</span> Add Questions
                            </button>
                            <button id="loadSheetsBtn" onclick="loadQuestionsFromSheets()" class="bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400 font-semibold py-4 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition">
                                <span class="text-2xl">üìä</span> Load G-Sheets
                            </button>
                            <label class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 font-semibold py-4 px-4 rounded-lg flex flex-col items-center justify-center gap-2 cursor-pointer transition">
                                <span class="text-2xl">üìÑ</span> Import File
                                <input type="file" id="csvFileInput" accept=".csv, .xlsx" class="hidden">
                            </label>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder p-6 flex flex-col gap-4">
                        <h3 class="text-lg font-bold dark:text-darkText">General Settings</h3>
                        
                        <!-- Quiz Progression Toggle -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Quiz Progression</h4>
                            <div class="flex space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                <button class="flex-1 py-2 px-4 rounded-md text-xs font-medium quiz-flow-btn text-slate-500" data-flow="auto" onclick="setQuizFlow('auto')">Auto Next (2s)</button>
                                <button class="flex-1 py-2 px-4 rounded-md text-xs font-medium quiz-flow-btn text-slate-500" data-flow="manual" onclick="setQuizFlow('manual')">Manual Click</button>
                            </div>
                        </div>

                        <div class="flex items-center justify-between border-t dark:border-slate-700 pt-3">
                            <span class="text-sm font-medium dark:text-darkSubText">AI Tutoring (API Key)</span>
                            <button onclick="openAiSettingsModal()" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full border dark:border-slate-600 dark:text-darkText">Configure</button>
                        </div>
                        <div class="border-t dark:border-slate-700 pt-3">
                            <button onclick="resetAllData()" class="w-full text-red-600 hover:text-red-700 font-bold flex items-center justify-center gap-2 text-sm">üóëÔ∏è Reset All App Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Generator Screen -->
            <div id="generatorScreen" class="screen hidden">
                 <h2 class="text-2xl font-bold dark:text-darkText mb-6">AI Question Generator</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <div class="lg:col-span-1 space-y-6">
                         <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700">
                             <h3 class="font-bold mb-4 dark:text-darkText">1. Input Context</h3>
                             <label class="block mb-4">
                                 <span class="text-sm text-slate-500 block mb-1">Upload File (.txt or .pdf)</span>
                                 <input type="file" id="aiFileInput" accept=".txt, .pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 dark:file:bg-violet-900/30 dark:file:text-violet-400">
                             </label>
                             <div class="text-center text-xs text-slate-400 mb-2">- OR -</div>
                             <textarea id="aiTextInput" rows="6" class="w-full p-3 border rounded-lg dark:bg-slate-800 dark:text-darkText text-sm" placeholder="Paste your review notes or topic summary here..."></textarea>
                         </div>
                         
                         <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700">
                             <h3 class="font-bold mb-4 dark:text-darkText">2. Configuration</h3>
                             <div class="space-y-4">
                                 <div>
                                     <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Target Area</label>
                                     <select id="genTopicSelect" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText">
                                         <option>AREA 1</option><option>AREA 2</option><option>AREA 3</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Quantity</label>
                                     <select id="genCountSelect" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText">
                                         <option value="5">5 Questions</option>
                                         <option value="10">10 Questions</option>
                                         <option value="15">15 Questions</option>
                                         <option value="20">20 Questions</option>
                                         <option value="30">30 Questions</option>
                                         <option value="40">40 Questions</option>
                                         <option value="50">50 Questions</option>
                                         <option value="auto">Auto (Based on File Length)</option>
                                     </select>
                                 </div>
                                 <button onclick="generateQuestions()" id="genBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-lg transition">‚ú® Generate Questions</button>
                             </div>
                         </div>
                     </div>
                     
                     <div class="lg:col-span-2">
                         <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700 h-full flex flex-col">
                             <div class="flex justify-between items-center mb-4">
                                 <h3 class="font-bold dark:text-darkText">3. Review & Save</h3>
                                 <div class="flex gap-2">
                                     <button onclick="clearGenerated()" class="text-xs text-red-500 hover:text-red-700">Clear</button>
                                     <button onclick="saveGeneratedToApp()" id="saveGenBtn" class="bg-emerald-600 text-white text-xs px-3 py-1 rounded hidden">Save to App</button>
                                 </div>
                             </div>
                             <div id="genPreview" class="flex-1 bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 overflow-y-auto max-h-[500px] text-sm dark:text-slate-300">
                                 <div class="text-center text-slate-400 mt-10">Generated questions will appear here...</div>
                             </div>
                             <div class="mt-4 pt-4 border-t dark:border-slate-700">
                                 <button onclick="exportGeneratedToCSV()" id="exportCsvBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                     üì• Download CSV (For Google Sheets)
                                 </button>
                                 <p class="text-xs text-slate-400 mt-2 text-center">To save permanently: Download this CSV, then File > Import in your Google Sheet.</p>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>

            <!-- Topics Screen -->
            <div id="topicsScreen" class="screen hidden">
                <h2 class="text-2xl font-bold dark:text-darkText mb-6">Topic Organization</h2>
                <div class="bg-white dark:bg-darkCard rounded-xl border dark:border-darkBorder p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium dark:text-darkSubText">Add Topic (AREA 1, 2, etc.)</label>
                            <div class="flex"><input type="text" id="topicInput" placeholder="New Area Name" class="flex-1 rounded-l-lg border p-2 dark:bg-slate-700 dark:text-darkText"><button onclick="addTopic()" class="bg-emerald-600 text-white px-4 py-2 rounded-r-lg hover:bg-emerald-700">+</button></div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium dark:text-darkSubText">Add Subtopic</label>
                            <div class="flex gap-2">
                                <select id="parentTopicSelect" class="w-1/3 rounded-lg border p-2 dark:bg-slate-700 dark:text-darkText"></select>
                                <input type="text" id="subtopicInput" placeholder="Name" class="flex-1 rounded-l-lg border p-2 dark:bg-slate-700 dark:text-darkText"><button onclick="addSubtopic()" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="topicsContainer" class="space-y-3"></div>
            </div>

            <!-- Questions Screen -->
            <div id="questionsScreen" class="screen hidden">
                <h2 class="text-2xl font-bold dark:text-darkText mb-6">Question Bank</h2>
                <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-darkBorder mb-6">
                    <textarea id="questionInput" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-darkText mb-4" placeholder="Question text..."></textarea>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="optionA" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText" placeholder="A">
                        <input id="optionB" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText" placeholder="B">
                        <input id="optionC" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText" placeholder="C">
                        <input id="optionD" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText" placeholder="D">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="imageInput" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText" placeholder="Image URL (Optional)">
                        <select id="correctAnswer" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText">
                            <option value="">Correct Ans...</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
                        </select>
                    </div>
                    <button onclick="addQuestion()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold w-full">Add Question</button>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <select id="viewTopicFilter" onchange="renderQuestions()" class="p-2 border rounded dark:bg-slate-700 dark:text-darkText"></select>
                    <button onclick="clearFilteredQuestions()" class="text-red-500 text-sm font-bold">Clear All Filtered</button>
                </div>
                <div id="questionsContainer" class="space-y-2"></div>
            </div>

            <!-- Listen Mode Screen -->
            <div id="listenScreen" class="screen hidden">
                <div class="text-center max-w-2xl mx-auto py-10">
                    <div id="listenLandingArea">
                        <div class="text-6xl mb-4">üéß</div>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-darkText mb-4">Listen Mode</h2>
                        <div class="bg-white dark:bg-darkCard p-6 rounded-xl border border-slate-200 dark:border-darkBorder shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-center">
                            <div class="w-full md:w-1/2 text-left">
                                <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Area</label>
                                <select id="listenTopicSelect" onchange="updateSubtopics('listenTopicSelect', 'listenSubtopicSelect')" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText dark:border-slate-700 font-bold"></select>
                            </div>
                            <div class="w-full md:w-1/2 text-left">
                                <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Subtopic</label>
                                <select id="listenSubtopicSelect" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText dark:border-slate-700"></select>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-start gap-4 mb-6 w-full max-w-2xl mx-auto">
                        <div class="flex-shrink-0 pt-2 mx-auto md:mx-0 w-24">
                            <svg class="w-12 h-12 mx-auto fill-current text-amber-500 dark:text-amber-400" viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8"/><rect x="6" y="7" width="1" height="1" fill="#1e293b"/><rect x="9" y="7" width="1" height="1" fill="#1e293b"/><rect x="7" y="9" width="2" height="1" fill="#fefefe"/><polygon points="4,4 6,2 6,4" /><polygon points="12,4 10,2 10,4" /></svg>
                            <div class="text-xs text-center font-bold text-slate-500 mt-1">ABELE Cat</div>
                        </div>
                        <div class="flex-1 w-full text-left">
                            <div id="listenBubble" class="speech-bubble border-slate-200 dark:border-slate-700 shadow-md">
                                <div id="listenText" class="listen-text font-bold text-slate-800 min-h-[50px] flex flex-col justify-center leading-relaxed">"Select an AREA and press start to begin!"</div>
                            </div>
                            <div class="mt-4 bg-white p-4 rounded-xl shadow-lg border border-slate-200 dark:border-darkBorder">
                                <div id="listenAnswer" class="text-emerald-600 font-black h-8 text-center text-xl"></div>
                                <div id="listenOptions" class="text-left mt-2 p-3 bg-white rounded-lg space-y-2 listen-text"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 bg-slate-100 dark:bg-slate-700 p-4 rounded-xl max-w-lg mx-auto">
                        <div class="text-left"><label class="flex justify-between text-xs font-bold text-slate-500 uppercase mb-2"><span>Voice Speed</span><span id="speedDisplay" class="text-emerald-600">1.0x</span></label><input type="range" id="speedInput" min="0.5" max="2" step="0.1" value="1" class="w-full"></div>
                        <div class="text-left"><label class="flex justify-between text-xs font-bold text-slate-500 uppercase mb-2"><span>Pause (s)</span><span id="pauseDisplay" class="text-emerald-600">2s</span></label><input type="range" id="pauseInput" min="0" max="10" step="1" value="2" class="w-full"></div>
                    </div>

                    <div class="flex justify-center gap-4 mt-4">
                        <button onclick="skipListen(-1)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-full dark:bg-slate-700 dark:text-darkText transition">Prev</button>
                        <button onclick="toggleListen()" id="listenBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">Start Listening</button>
                        <button onclick="skipListen(1)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-full dark:bg-slate-700 dark:text-darkText transition">Next</button>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-2 gap-4 max-w-sm mx-auto text-left">
                        <label class="flex items-center space-x-2 bg-white dark:bg-darkCard p-3 rounded shadow-sm cursor-pointer border border-slate-200 dark:border-darkBorder"><input type="checkbox" id="readOptionsCheck" class="text-purple-600 rounded"><span class="text-sm select-none">Read Options</span></label>
                        <label class="flex items-center space-x-2 bg-white dark:bg-darkCard p-3 rounded shadow-sm cursor-pointer border border-slate-200 dark:border-darkBorder"><input type="checkbox" id="autoNextCheck" checked class="text-purple-600 rounded"><span class="text-sm select-none">Auto Next</span></label>
                    </div>
                </div>
            </div>

            <!-- Quiz Screen -->
            <div id="quizScreen" class="screen hidden">
                <div class="max-w-3xl mx-auto">
                    <div id="quizStartView" class="text-center py-12">
                        <div class="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl dark:bg-emerald-900/50">‚ö°</div>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-darkText mb-2">Mastery Quiz</h2>
                        <div class="bg-white dark:bg-darkCard p-6 rounded-xl shadow-sm border border-slate-200 dark:border-darkBorder mb-8 text-left max-w-md mx-auto">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Topic</label><select id="quizTopicSelect" onchange="updateSubtopics('quizTopicSelect', 'quizSubtopicSelect')" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText font-bold"></select></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Subtopic</label><select id="quizSubtopicSelect" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText"></select></div>
                            </div>
                            <div class="mb-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Session Size</label>
                                <select id="quizCountSelect" class="w-full p-2 border rounded-lg dark:bg-slate-800 dark:text-darkText">
                                    <option value="20">20 Qs</option>
                                    <option value="50">50 Qs</option>
                                    <option value="100">100 Qs</option>
                                    <option value="200">200 Qs</option>
                                    <option value="500">500 Qs</option>
                                    <option value="1000">1000 Qs</option>
                                    <option value="all">All Available</option>
                                </select>
                            </div>
                            <div class="flex justify-between text-slate-600 dark:text-darkSubText"><span>Available:</span><span class="font-bold text-slate-800 dark:text-darkText" id="quizQCountDisplay">0</span></div>
                        </div>
                        <button id="startQuizBtn" onclick="initQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:scale-105">Start Quiz</button>
                    </div>

                    <div id="quizActiveView" class="hidden">
                        <div class="w-full h-2 bg-slate-200 dark:bg-slate-700 mb-4 rounded-full overflow-hidden"><div id="progressBar" class="h-full bg-emerald-600" style="width: 0;"></div></div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-slate-500 dark:text-darkSubText font-medium">Mastered: <span id="qMastered">0</span> / <span id="qInitialTotal">0</span></div>
                            <div class="flex space-x-4"><div class="text-lg font-bold text-emerald-600">‚úÖ <span id="qCorrectCount">0</span></div><div class="text-lg font-bold text-red-600">‚ùå <span id="qWrongCount">0</span></div></div>
                        </div>
                        <div class="bg-white dark:bg-darkCard rounded-xl shadow-lg border border-slate-200 dark:border-darkBorder p-8 mb-6">
                            <div id="qImageArea" class="max-w-full max-h-96 mx-auto mb-4 overflow-hidden rounded-lg"></div>
                            <div class="flex items-start gap-4 mb-6">
                                <div class="flex-shrink-0 pt-2 w-16"><svg class="w-12 h-12 mx-auto fill-current text-amber-500 dark:text-amber-400" viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8"/><rect x="6" y="7" width="1" height="1" fill="#1e293b"/><rect x="9" y="7" width="1" height="1" fill="#1e293b"/><rect x="7" y="9" width="2" height="1" fill="#fefefe"/><polygon points="4,4 6,2 6,4" /><polygon points="12,4 10,2 10,4" /></svg></div>
                                <div class="flex-1 w-full"><div class="speech-bubble border-slate-200 dark:border-slate-700 shadow-sm"><div id="qText" class="text-lg font-medium text-slate-800 leading-relaxed"></div></div></div>
                            </div>
                            <div id="qOptions" class="space-y-3 w-full"></div>
                            <div id="qFeedback" class="hidden w-full p-4 rounded-lg bg-slate-50 border mt-4">
                                <div id="feedbackText" class="mb-3"></div>
                                <div id="aiExplanation" class="hidden">
                                    <button id="aiAskBtn" onclick="askAIForExplanation()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-200 transition">Ask AI Why</button>
                                    <div id="aiResponseArea" class="mt-4 text-sm text-slate-700 border-t border-slate-200 pt-3 dark:text-darkSubText dark:border-slate-600"></div>
                                </div>
                                <button id="qContinueBtn" onclick="nextQuestion()" class="hidden mt-4 bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-lg transition">Continue ‚Üí</button>
                            </div>
                        </div>
                    </div>

                    <div id="quizResultsView" class="hidden text-center py-8">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-darkText mb-6">Complete!</h2>
                        <div class="grid grid-cols-3 gap-4 mb-8">
                            <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700 shadow-sm"><div class="text-4xl font-bold text-emerald-600" id="resCorrect">0</div><div class="text-sm text-slate-500 mt-1 uppercase tracking-wide">Mastered</div></div>
                            <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700 shadow-sm"><div class="text-4xl font-bold text-red-600" id="resWrong">0</div><div class="text-sm text-slate-500 mt-1 uppercase tracking-wide">Attempts</div></div>
                            <div class="bg-white dark:bg-darkCard p-6 rounded-xl border dark:border-slate-700 shadow-sm"><div class="text-4xl font-bold text-purple-600" id="resTime">00:00</div><div class="text-sm text-slate-500 mt-1 uppercase tracking-wide">Time</div></div>
                        </div>
                        <button onclick="switchToScreen('quizTab')" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">Back to Start</button>
                    </div>
                </div>
            </div>

            <!-- Focus Screen -->
            <div id="focusScreen" class="screen hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border dark:border-darkBorder p-8 text-center">
                        <h2 class="text-2xl font-bold dark:text-darkText mb-8">Focus Timer</h2>
                        <div class="relative w-64 h-64 mx-auto mb-8">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" stroke="#f1f5f9" stroke-width="6" fill="none" class="dark:stroke-slate-700"/>
                                <circle id="focusProgress" cx="50" cy="50" r="45" stroke="#0f766e" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" class="transition-all duration-1000 dark:stroke-emerald-400"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="focusDisplay" class="text-5xl font-mono font-bold dark:text-darkText">25:00</span></div>
                        </div>
                        <div class="flex justify-center gap-4 mb-8">
                            <button onclick="toggleTimer()" id="timerToggleBtn" class="bg-emerald-600 text-white w-16 h-16 rounded-full text-2xl shadow-lg transition active:scale-95">‚ñ∂</button>
                            <button onclick="resetTimer()" class="bg-slate-200 text-slate-600 w-16 h-16 rounded-full text-xl dark:bg-slate-700 transition active:scale-95">‚Ü∫</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setTimer(25)" class="py-2 bg-slate-100 rounded text-sm dark:bg-slate-700">Pomodoro</button>
                            <button onclick="setTimer(15)" class="py-2 bg-slate-100 rounded text-sm dark:bg-slate-700">Short</button>
                            <button onclick="setTimer(60)" class="py-2 bg-slate-100 rounded text-sm dark:bg-slate-700">Long</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border dark:border-darkBorder p-6 flex flex-col">
                        <h2 class="text-xl font-bold dark:text-darkText mb-4">Study Tasks</h2>
                        <div class="flex gap-2 mb-4"><input type="text" id="newTaskInput" class="flex-1 border rounded-lg px-3 py-2 dark:bg-slate-700 dark:text-darkText" placeholder="Task..."><button onclick="addTask()" class="bg-blue-600 text-white px-4 rounded-lg">+</button></div>
                        <div id="tasksList" class="flex-1 overflow-y-auto space-y-2 max-h-[300px]"></div>
                        <div class="pt-4 mt-4 border-t dark:border-slate-700 text-sm text-slate-500 flex justify-between"><span id="taskCount">0 pending</span><button onclick="clearCompletedTasks()" class="text-red-500">Clear Done</button></div>
                    </div>
                </div>
            </div>

            <!-- About Screen -->
            <div id="aboutScreen" class="screen hidden">
                <div class="max-w-2xl mx-auto prose prose-slate dark:prose-invert text-center">
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-darkText mb-4">About ABELE Engine</h1>
                    <p class="text-slate-600 dark:text-darkSubText mb-8">Designed for Agricultural and Biosystems Engineering Licensure Exam review.</p>
                    <p class="font-bold">Version: 4.1 Pro (AI Generator & Mastery)</p>
                    <p class="mb-8">Created by: An AB Engineering Student</p>
                    
                    <div class="bg-emerald-50 p-6 rounded-xl border border-emerald-100 dark:bg-emerald-900/50 dark:border-emerald-900 inline-block">
                        <h3 class="font-bold text-emerald-800 text-lg dark:text-emerald-400 mb-2">Support the Dev ‚òï</h3>
                        <p class="text-emerald-700 dark:text-emerald-300 text-sm mb-4">If this tool helps you, check out my art portfolio!</p>
                        <a href="https://thisartpaidformycoffeeandchapter3.my.canva.site/" target="_blank" class="bg-emerald-600 text-white px-6 py-2 rounded-full text-sm font-bold hover:bg-emerald-700 transition shadow-lg transform hover:scale-105 inline-block">Visit Portfolio</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const API_KEY = "";
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDp0e7PNGHX3xQTJknm9ilPOwvumjprES3JoBDx_XQnQczrSj1Tb6LG5f_xIEyCjAp/exec';

        const DEFAULT_TOPICS = [
            { name: 'AREA 1', subtopics: ['Machinery', 'Power', 'Mechanization'], expanded: true },
            { name: 'AREA 2', subtopics: ['Irrigation', 'Hydrology', 'Soil & Water'], expanded: false },
            { name: 'AREA 3', subtopics: ['Structures', 'Environment', 'Processing'], expanded: false }
        ];

        let state = { questions: [], topics: [], tasks: [], settings: { quizMode: 'multiple-choice', quizFlow: 'auto', speechRate: 1.0, pauseDuration: 2, darkMode: false, aiStyle: 'formal', aiLang: 'en', apiKey: '' } };
        let activeQuiz = { questions: [], initialTotal: 0, masteredCount: 0, index: 0, score: 0, wrong: 0, startTime: 0, timerInterval: null };
        let focusTimer = { timeLeft: 25 * 60, originalTime: 25 * 60, interval: null, isRunning: false };
        let listenState = { active: false, currentIndex: 0, timeoutId: null, filteredQuestions: [] };
        let currentUtterance = null;
        let generatedQuestionsCache = [];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(isCorrect) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if(isCorrect) { osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1); }
            else { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.2); }
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        window.addEventListener('load', () => { loadData(); initUI(); });

        function saveData() { localStorage.setItem('abele_pro_final_v8', JSON.stringify(state)); }
        function loadData() {
            const stored = localStorage.getItem('abele_pro_final_v8');
            if (stored) {
                state = JSON.parse(stored);
                if (!state.tasks) state.tasks = [];
                if (!state.settings) state.settings = { quizMode: 'multiple-choice', quizFlow: 'auto', speechRate: 1.0, pauseDuration: 2, darkMode: false, aiStyle: 'formal', aiLang: 'en', apiKey: '' };
                if (!state.settings.quizFlow) state.settings.quizFlow = 'auto';
            } else {
                state.topics = DEFAULT_TOPICS;
            }
        }

        function resetAllData() { if(confirm("Clear all data and settings?")) { localStorage.removeItem('abele_pro_final_v8'); location.reload(); } }

        function initUI() {
            applyDarkMode(state.settings.darkMode);
            updateDashboard();
            renderTopics();
            renderTasks();
            populateTopicSelectors();
            setQuizFlow(state.settings.quizFlow || 'auto');
            document.getElementById('speedInput').value = state.settings.speechRate || 1.0;
            document.getElementById('speedDisplay').innerText = (state.settings.speechRate || 1.0) + 'x';
            document.getElementById('pauseInput').value = state.settings.pauseDuration || 2;
            document.getElementById('pauseDisplay').innerText = (state.settings.pauseDuration || 2) + 's';
            if(state.settings.apiKey) document.getElementById('apiKeyInput').value = state.settings.apiKey;
        }

        function populateTopicSelectors() {
            const selectors = ['quizTopicSelect', 'listenTopicSelect', 'viewTopicFilter', 'parentTopicSelect'];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = (id === 'parentTopicSelect') ? '' : '<option value="">All Areas</option>';
                state.topics.forEach(t => { const o = document.createElement('option'); o.value = t.name; o.innerText = t.name; el.appendChild(o); });
            });
            updateSubtopics('quizTopicSelect', 'quizSubtopicSelect');
            updateSubtopics('listenTopicSelect', 'listenSubtopicSelect');
        }

        function updateSubtopics(topicId, subtopicId) {
            const topicName = document.getElementById(topicId).value;
            const subSelector = document.getElementById(subtopicId);
            if (!subSelector) return;
            subSelector.innerHTML = '<option value="">All Subtopics</option>';
            if (topicName) {
                const topic = state.topics.find(t => t.name === topicName);
                if (topic && topic.subtopics) topic.subtopics.forEach(s => { const o = document.createElement('option'); o.value = s; o.innerText = s; subSelector.appendChild(o); });
            }
            if (topicId === 'quizTopicSelect') updateQuizTotalCount(true);
        }

        function toggleDarkMode() { state.settings.darkMode = !state.settings.darkMode; applyDarkMode(state.settings.darkMode); saveData(); }
        function applyDarkMode(isDark) {
            const html = document.documentElement;
            if (isDark) { html.classList.add('dark'); document.getElementById('sunIcon').classList.remove('hidden'); document.getElementById('moonIcon').classList.add('hidden'); }
            else { html.classList.remove('dark'); document.getElementById('sunIcon').classList.add('hidden'); document.getElementById('moonIcon').classList.remove('hidden'); }
        }

        function switchToScreen(tabId) {
            stopListening();
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId.replace('Tab', 'Screen')).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-emerald-600', 'hover:bg-emerald-700', 'text-amber-400'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('hover:bg-slate-600'));
            const activeBtn = document.getElementById(tabId);
            if(activeBtn) {
                activeBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                activeBtn.classList.remove('hover:bg-slate-600');
            }
            if(tabId === 'generatorTab') activeBtn.classList.add('text-amber-400');

            if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('hidden');
            
            if (tabId === 'quizTab') {
                document.getElementById('quizStartView').classList.remove('hidden');
                document.getElementById('quizActiveView').classList.add('hidden');
                document.getElementById('quizResultsView').classList.add('hidden');
            }
            
            if (tabId === 'questionsTab') renderQuestions();
        }

        function updateDashboard() {
            document.getElementById('totalQuestionCount').innerText = state.questions.length;
            document.getElementById('totalTopicsCount').innerText = state.topics.length;
            let subCount = 0; state.topics.forEach(t => subCount += (t.subtopics ? t.subtopics.length : 0));
            document.getElementById('totalSubtopicsCount').innerText = subCount;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-emerald-600'} text-white px-6 py-3 rounded-lg shadow-lg font-medium mb-2`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- AI GENERATOR ---
        document.getElementById('aiFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('aiTextInput').value = e.target.result; showToast("Text file loaded!"); };
                reader.readAsText(file);
            } else if (file.type === 'application/pdf') {
                showToast("Parsing PDF... please wait.");
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(" ") + "\n";
                    }
                    document.getElementById('aiTextInput').value = fullText;
                    showToast(`PDF loaded! (${pdf.numPages} pages)`);
                } catch (err) { console.error(err); showToast("Error parsing PDF.", "error"); }
            } else { showToast("Unsupported file type. Use .txt or .pdf", "error"); }
        });

        async function generateQuestions() {
            const context = document.getElementById('aiTextInput').value.trim();
            const apiKey = state.settings.apiKey;

            if (!apiKey) {
                openAiSettingsModal();
                return showToast("Please enter your Gemini API Key in settings.", "error");
            }

            if (!context) return showToast("Please enter text or upload a file.", "error");
            
            let count = document.getElementById('genCountSelect').value;
            if (count === 'auto') {
                 count = Math.min(50, Math.max(5, Math.floor(context.length / 300))); // Roughly 1 q per 300 chars
                 showToast(`Auto-detecting: Generating ~${count} questions...`);
            }

            const topic = document.getElementById('genTopicSelect').value;
            const btn = document.getElementById('genBtn');
            const preview = document.getElementById('genPreview');
            
            btn.disabled = true;
            btn.innerHTML = "Generating... (This may take a moment)";
            preview.innerHTML = '<div class="text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto"></div></div>';

            try {
                const prompt = `Generate ${count} multiple choice questions (A,B,C,D) based on this text. Topic: ${topic}. 
                Format strictly as a JSON array of objects with keys: "question", "options" (array of 4 strings), "correct" (index 0-3). 
                Do not include markdown code blocks. Text: ${context.substring(0, 15000)}`; // Increased context window

                const res = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const result = await res.json();
                if(result.error) throw result.error;
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const questions = JSON.parse(text);

                generatedQuestionsCache = questions.map(q => ({
                    id: Date.now() + Math.random(),
                    question: q.question,
                    options: q.options,
                    correct: q.correct,
                    topic: topic,
                    subtopic: 'AI Generated',
                    image: null
                }));

                renderGeneratedPreview();
                document.getElementById('saveGenBtn').classList.remove('hidden');
                document.getElementById('exportCsvBtn').disabled = false;
                showToast(`Generated ${generatedQuestionsCache.length} questions!`);

            } catch (e) {
                console.error(e);
                preview.innerHTML = `<div class="text-red-500 text-center text-sm p-4">Generation failed. ${e.message || "Check API Key or try shorter text."}</div>`;
                showToast("Generation failed", "error");
            }
            btn.disabled = false;
            btn.innerHTML = "‚ú® Generate Questions";
        }

        function renderGeneratedPreview() {
            const container = document.getElementById('genPreview');
            container.innerHTML = '';
            generatedQuestionsCache.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-white dark:bg-slate-800 rounded border dark:border-slate-700';
                div.innerHTML = `
                    <div class="font-bold mb-2 dark:text-slate-200">${i+1}. ${q.question}</div>
                    <ul class="text-xs space-y-1 text-slate-600 dark:text-slate-400">
                        ${q.options.map((o, idx) => `<li class="${idx === q.correct ? 'text-emerald-600 font-bold' : ''}">${String.fromCharCode(65+idx)}. ${o}</li>`).join('')}
                    </ul>
                `;
                container.appendChild(div);
            });
        }

        function saveGeneratedToApp() {
            if (generatedQuestionsCache.length === 0) return;
            state.questions = [...state.questions, ...generatedQuestionsCache];
            saveData();
            updateDashboard();
            showToast(`${generatedQuestionsCache.length} questions saved to App!`);
            generatedQuestionsCache = [];
            document.getElementById('genPreview').innerHTML = '<div class="text-center text-slate-400 mt-10">Saved! Generate more?</div>';
            document.getElementById('saveGenBtn').classList.add('hidden');
            document.getElementById('exportCsvBtn').disabled = true;
        }

        function clearGenerated() {
            generatedQuestionsCache = [];
            document.getElementById('genPreview').innerHTML = '<div class="text-center text-slate-400 mt-10">Generated questions will appear here...</div>';
            document.getElementById('saveGenBtn').classList.add('hidden');
            document.getElementById('exportCsvBtn').disabled = true;
        }

        function exportGeneratedToCSV() {
            if (generatedQuestionsCache.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8,Question,Option A,Option B,Option C,Option D,Correct Answer (0-3),Topic,Subtopic,Image URL\n";
            generatedQuestionsCache.forEach(q => {
                const clean = (text) => `"${String(text).replace(/"/g, '""')}"`;
                const row = [clean(q.question), clean(q.options[0]), clean(q.options[1]), clean(q.options[2]), clean(q.options[3]), q.correct, clean(q.topic), clean(q.subtopic), ""].join(",");
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_questions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- QUIZ LOGIC ---
        function setQuizFlow(flow) {
            state.settings.quizFlow = flow;
            document.querySelectorAll('.quiz-flow-btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                if (b.dataset.flow === flow) b.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
            });
            saveData();
        }

        function setQuizMode(mode) {
            state.settings.quizMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                if (b.dataset.mode === mode) b.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
            });
            saveData();
        }

        function updateQuizTotalCount(useFilter = false) {
            let questions = state.questions;
            if (useFilter) {
                const t = document.getElementById('quizTopicSelect').value;
                const s = document.getElementById('quizSubtopicSelect').value;
                if (t) questions = questions.filter(q => q.topic === t);
                if (s) questions = questions.filter(q => q.subtopic === s);
            }
            document.getElementById('quizQCountDisplay').innerText = questions.length;
        }

        function initQuiz() {
            let questions = state.questions;
            const t = document.getElementById('quizTopicSelect').value;
            const s = document.getElementById('quizSubtopicSelect').value;
            if (t) questions = questions.filter(q => q.topic === t);
            if (s) questions = questions.filter(q => q.subtopic === s);
            if (!questions.length) return showToast('No questions found!', 'error');

            const size = document.getElementById('quizCountSelect').value;
            let shuffled = questions.sort(() => 0.5 - Math.random());
            if (size !== 'all') shuffled = shuffled.slice(0, parseInt(size));

            // Initialize mastery quiz state with shuffling options logic
            activeQuiz = { 
                questions: shuffled.map(q => {
                    // Create pairs of text + original correct flag
                    const opts = q.options.map((text, i) => ({ text, isCorrect: i === q.correct }));
                    // Shuffle the pairs
                    opts.sort(() => 0.5 - Math.random());
                    // Re-construct the object with new order
                    return {
                        ...q,
                        options: opts.map(o => o.text),
                        correct: opts.findIndex(o => o.isCorrect),
                        isFirstAttempt: true,
                        solved: false
                    };
                }), 
                initialTotal: shuffled.length, 
                masteredCount: 0, 
                index: 0, 
                score: 0, 
                wrong: 0, 
                startTime: Date.now(), 
                timerInterval: null 
            };
            
            document.getElementById('quizStartView').classList.add('hidden');
            document.getElementById('quizActiveView').classList.remove('hidden');
            activeQuiz.timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - activeQuiz.startTime)/1000);
                const m = Math.floor(diff/60).toString().padStart(2,'0');
                const s = (diff%60).toString().padStart(2,'0');
                const el = document.getElementById('resTime');
                if(el) el.innerText = `${m}:${s}`;
            }, 1000);
            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            const q = activeQuiz.questions[activeQuiz.index];
            document.getElementById('qText').innerText = q.question;
            document.getElementById('qCorrectCount').innerText = activeQuiz.score;
            document.getElementById('qWrongCount').innerText = activeQuiz.wrong;
            
            const solvedCount = activeQuiz.questions.slice(0, activeQuiz.initialTotal).filter(q => q.solved).length;
            document.getElementById('progressBar').style.width = `${(solvedCount / activeQuiz.initialTotal) * 100}%`;
            document.getElementById('qMastered').innerText = activeQuiz.masteredCount;
            document.getElementById('qInitialTotal').innerText = activeQuiz.initialTotal;

            const imageArea = document.getElementById('qImageArea');
            imageArea.innerHTML = '';
            if(q.image) { 
                const img = document.createElement('img'); 
                img.src = q.image; img.className = 'w-full h-auto object-contain max-h-64 mb-4 rounded-lg'; 
                imageArea.appendChild(img);
            }

            const opts = document.getElementById('qOptions');
            opts.innerHTML = '';
            document.getElementById('qFeedback').classList.add('hidden');
            document.getElementById('aiExplanation').classList.add('hidden');
            document.getElementById('aiResponseArea').innerHTML = '';
            document.getElementById('qContinueBtn').classList.add('hidden');
            
            q.options.forEach((opt, idx) => {
                if (!opt) return;
                const btn = document.createElement('button');
                btn.className = 'quiz-choice w-full text-left p-4 rounded-lg border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-800 dark:text-darkText transition font-medium';
                btn.innerHTML = `<span class="bg-slate-100 dark:bg-slate-700 w-8 h-8 inline-flex items-center justify-center rounded-full mr-3 font-bold text-sm">${String.fromCharCode(65+idx)}</span> ${opt}`;
                btn.onclick = () => submitAnswer(idx);
                opts.appendChild(btn);
            });
        }

        function submitAnswer(idx) {
            document.querySelectorAll('.quiz-choice').forEach(b => b.disabled = true);
            const q = activeQuiz.questions[activeQuiz.index];
            const isCorrect = idx === q.correct;
            handleFeedback(isCorrect, q.options[q.correct]);
        }

        function handleFeedback(isCorrect, correctText) {
            const q = activeQuiz.questions[activeQuiz.index];
            const fb = document.getElementById('qFeedback');
            const txt = document.getElementById('feedbackText');
            fb.classList.remove('hidden');
            document.getElementById('aiExplanation').classList.remove('hidden');

            if (isCorrect) {
                txt.innerHTML = `<div class="text-emerald-700 font-bold">‚úÖ Correct!</div>`;
                activeQuiz.score++;
                if (q.isFirstAttempt) { activeQuiz.masteredCount++; }
                q.solved = true;
                playSound(true);
            } else {
                txt.innerHTML = `<div class="text-red-700 font-bold">‚ùå Incorrect</div><div class="text-slate-600 dark:text-slate-400">Answer: ${correctText}</div>`;
                activeQuiz.wrong++;
                q.isFirstAttempt = false;
                
                // Duplicate object for re-queueing to ensure re-test
                // We create a deep copy so it remains distinct in the queue
                const retryQ = JSON.parse(JSON.stringify(q));
                retryQ.solved = false; // Ensure copy is marked unsolved
                activeQuiz.questions.push(retryQ);
                
                playSound(false);
            }

            if (state.settings.quizFlow === 'auto') {
                setTimeout(nextQuestion, 2000);
            } else {
                document.getElementById('qContinueBtn').classList.remove('hidden');
            }
        }

        function nextQuestion() {
            let attempts = 0;
            const maxAttempts = activeQuiz.questions.length + 1; // Safety break
            
            // Loop until we find an unsolved question or finish
            while(attempts < maxAttempts) {
                activeQuiz.index++;
                
                if (activeQuiz.index >= activeQuiz.questions.length) {
                    // Start checking from the beginning again if we hit the end
                    // This is crucial for the Mastery Loop
                    activeQuiz.index = 0;
                }
                
                const nextQ = activeQuiz.questions[activeQuiz.index];
                
                // If we found a question that hasn't been solved yet, show it
                if (!nextQ.solved) {
                    renderQuizQuestion();
                    return;
                }
                
                attempts++;
            }
            
            finishQuiz();
        }
        
        function finishQuiz() {
            clearInterval(activeQuiz.timerInterval);
            document.getElementById('quizActiveView').classList.add('hidden');
            document.getElementById('quizResultsView').classList.remove('hidden');
            document.getElementById('resCorrect').innerText = activeQuiz.initialTotal;
            document.getElementById('resWrong').innerText = activeQuiz.wrong;
        }

        // --- LISTEN MODE ---
        document.getElementById('speedInput').addEventListener('input', e => { 
            const val = parseFloat(e.target.value);
            state.settings.speechRate = val; 
            document.getElementById('speedDisplay').innerText = val + 'x'; 
            saveData();
            if(listenState.active) { 
                window.speechSynthesis.cancel(); 
                if(listenState.timeoutId) clearTimeout(listenState.timeoutId); 
                playListenLoop(); 
            }
        });
        document.getElementById('pauseInput').addEventListener('input', e => { 
            const val = parseInt(e.target.value);
            state.settings.pauseDuration = val; 
            document.getElementById('pauseDisplay').innerText = val + 's'; 
            saveData();
        });

        function toggleListen() {
            if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) { 
                window.speechSynthesis.pause(); 
                setListenBtn(true); 
            }
            else if (window.speechSynthesis.paused) { 
                window.speechSynthesis.resume(); 
                setListenBtn(false); 
            }
            else {
                if (listenState.active) { stopListening(); }
                else {
                    const t = document.getElementById('listenTopicSelect').value;
                    const s = document.getElementById('listenSubtopicSelect').value;
                    let questions = state.questions;
                    if (t) questions = questions.filter(q => q.topic === t);
                    if (s) questions = questions.filter(q => q.subtopic === s);
                    if (!questions.length) return showToast('No questions found!', 'error');
                    document.getElementById('listenLandingArea').classList.add('hidden');
                    listenState.filteredQuestions = questions; listenState.active = true; listenState.currentIndex = 0;
                    setListenBtn(false); playListenLoop();
                }
            }
        }
        function stopListening() { window.speechSynthesis.cancel(); if(listenState.timeoutId) clearTimeout(listenState.timeoutId); listenState.active = false; setListenBtn(false); document.getElementById('listenLandingArea').classList.remove('hidden'); document.getElementById('listenText').innerText = "Stopped."; document.getElementById('listenAnswer').innerText = ""; document.getElementById('listenOptions').innerHTML = ""; }
        function setListenBtn(p) { document.getElementById('listenBtn').innerText = listenState.active ? (p ? "Resume" : "Stop Session") : "Start Listening"; }
        function skipListen(d) { window.speechSynthesis.cancel(); if(listenState.timeoutId) clearTimeout(listenState.timeoutId); const list = listenState.filteredQuestions; if(!list.length) return; listenState.currentIndex = (listenState.currentIndex + d + list.length) % list.length; updateListenScreenContent(listenState.currentIndex); if (listenState.active) playListenLoop(); }
        
        function playListenLoop() {
            const list = listenState.filteredQuestions;
            if (!listenState.active || !list.length) return;
            if (listenState.currentIndex >= list.length) listenState.currentIndex = 0;
            const q = list[listenState.currentIndex];
            updateListenScreenContent(listenState.currentIndex);
            
            const utterance = new SpeechSynthesisUtterance(q.question);
            utterance.rate = state.settings.speechRate || 1.0;
            
            utterance.onend = () => {
                if (!listenState.active) return;
                const reveal = () => {
                    document.getElementById('listenAnswer').innerText = q.options[q.correct];
                    renderListenOptions(q, q.correct);
                    const ansUtterance = new SpeechSynthesisUtterance("The answer is " + q.options[q.correct]);
                    ansUtterance.rate = state.settings.speechRate || 1.0;
                    ansUtterance.onend = () => { if (document.getElementById('autoNextCheck').checked && listenState.active) listenState.timeoutId = setTimeout(() => { listenState.currentIndex++; playListenLoop(); }, (state.settings.pauseDuration || 2) * 1000); };
                    window.speechSynthesis.speak(ansUtterance);
                };
                if (document.getElementById('readOptionsCheck').checked) {
                    const optText = q.options.map((o, i) => `${String.fromCharCode(65+i)}, ${o}`).join(". ");
                    const optUtt = new SpeechSynthesisUtterance(optText);
                    optUtt.rate = state.settings.speechRate || 1.0;
                    listenState.timeoutId = setTimeout(() => { if (listenState.active) { optUtt.onend = reveal; window.speechSynthesis.speak(optUtt); } }, 1000);
                } else listenState.timeoutId = setTimeout(reveal, 1500);
            };
            window.speechSynthesis.speak(utterance);
        }
        function updateListenScreenContent(idx) {
            const q = listenState.filteredQuestions[idx];
            document.getElementById('listenText').innerText = q.question;
            document.getElementById('listenAnswer').innerText = "";
            renderListenOptions(q, -1);
        }
        function renderListenOptions(q, correctIdx) {
            const container = document.getElementById('listenOptions'); container.innerHTML = '';
            q.options.forEach((opt, idx) => {
                if (!opt) return;
                const div = document.createElement('div');
                div.className = `p-2 rounded transition text-slate-800 ${correctIdx === -1 ? 'bg-white' : (idx === correctIdx ? 'bg-emerald-100 font-bold' : 'bg-white text-slate-400 line-through')}`;
                div.innerHTML = `<span class="font-mono mr-2 text-sm">${String.fromCharCode(65 + idx)}.</span> ${opt}`;
                container.appendChild(div);
            });
        }

        // --- FETCH & FILES ---
        async function loadQuestionsFromSheets() {
            showToast("Fetching from G-Sheets...");
            try {
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL);
                const data = await res.json();
                if(data.success && data.questions) {
                    const mapped = data.questions.map(q => ({ id: Date.now() + Math.random(), question: q.question, options: [q.optionA, q.optionB, q.optionC, q.optionD], correct: parseInt(q.correct), topic: String(q.topic || 'AREA 1').toUpperCase().trim(), subtopic: q.subtopic || '', image: q.image || null }));
                    state.questions = [...state.questions, ...mapped];
                    saveData(); updateDashboard(); populateTopicSelectors(); showToast(`Imported ${mapped.length}!`);
                }
            } catch(e) { showToast("Failed to load.", "error"); }
        }
        document.getElementById('csvFileInput').addEventListener('change', e => {
            const f = e.target.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = e => {
                let rows = f.name.endsWith('xlsx') ? XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type:'array'}).SheetNames[0]], {header:1}) : e.target.result.split('\n').map(l => l.split(','));
                rows.slice(1).forEach(r => { if(r.length >= 6) state.questions.push({ id:Date.now()+Math.random(), question:String(r[0]), options:[r[1],r[2],r[3],r[4]], correct:parseInt(r[5])||0, topic:String(r[6]||'AREA 1').toUpperCase().trim(), subtopic:r[7]||'', image:r[8]||null }); });
                saveData(); updateDashboard(); showToast("Imported!"); populateTopicSelectors();
            };
            if(f.name.endsWith('xlsx')) reader.readAsArrayBuffer(f); else reader.readAsText(f);
        });

        // --- AI TUTOR ---
        async function askAIForExplanation() {
            const apiKey = state.settings.apiKey;
            if(!apiKey) { openAiSettingsModal(); return showToast("API Key Required", "error"); }

            const q = activeQuiz.questions[activeQuiz.index];
            const aiArea = document.getElementById('aiResponseArea');
            aiArea.innerHTML = "Thinking...";
            try {
                const res = await fetch(GEMINI_API_URL + apiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Explain correctly why the answer to "${q.question}" is "${q.options[q.correct]}". Style: ${state.settings.aiStyle}, Lang: ${state.settings.aiLang}` }] }] }) });
                const result = await res.json(); aiArea.innerHTML = `<p class="font-bold text-blue-600">AI Tutor:</p>` + result.candidates[0].content.parts[0].text;
            } catch (e) { aiArea.innerHTML = "Error fetching explanation."; }
        }

        // --- TIMER & TASKS ---
        function setTimer(m) { focusTimer.originalTime = focusTimer.timeLeft = m * 60; updateTimerDisplay(); }
        function toggleTimer() {
            const btn = document.getElementById('timerToggleBtn');
            if(focusTimer.isRunning) { clearInterval(focusTimer.interval); focusTimer.isRunning = false; btn.innerText = "‚ñ∂"; }
            else { focusTimer.interval = setInterval(() => { if(focusTimer.timeLeft > 0) { focusTimer.timeLeft--; updateTimerDisplay(); updateProgressRing(); } else { clearInterval(focusTimer.interval); showToast("Done!", "success"); playSound(true); } }, 1000); focusTimer.isRunning = true; btn.innerText = "‚è∏"; }
        }
        function resetTimer() { clearInterval(focusTimer.interval); focusTimer.isRunning = false; focusTimer.timeLeft = focusTimer.originalTime; updateTimerDisplay(); updateProgressRing(); }
        function updateTimerDisplay() { const m = Math.floor(focusTimer.timeLeft / 60).toString().padStart(2, '0'); const s = (focusTimer.timeLeft % 60).toString().padStart(2, '0'); document.getElementById('focusDisplay').innerText = `${m}:${s}`; }
        function updateProgressRing() { const circ = 45 * 2 * Math.PI; document.getElementById('focusProgress').style.strokeDashoffset = circ - (focusTimer.timeLeft / focusTimer.originalTime) * circ; }
        function renderTasks() {
            const list = document.getElementById('tasksList'); list.innerHTML = '';
            document.getElementById('taskCount').innerText = `${state.tasks.filter(t => !t.completed).length} pending`;
            state.tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded-lg border ${task.completed ? 'opacity-60 bg-slate-50 dark:bg-slate-700' : 'bg-white dark:bg-slate-800'}`;
                div.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="rounded text-emerald-600"><span class="flex-1 ${task.completed ? 'line-through' : 'dark:text-darkText'} text-sm">${task.text}</span><button onclick="deleteTask(${task.id})" class="text-red-400">√ó</button>`;
                list.appendChild(div);
            });
        }
        function addTask() { const input = document.getElementById('newTaskInput'); if(input.value) { state.tasks.push({id: Date.now(), text: input.value, completed: false}); input.value=''; saveData(); renderTasks(); } }
        function toggleTask(id) { const t = state.tasks.find(x => x.id === id); t.completed = !t.completed; saveData(); renderTasks(); }
        function deleteTask(id) { state.tasks = state.questions = state.tasks.filter(x => x.id !== id); saveData(); renderTasks(); }
        function clearCompletedTasks() { state.tasks = state.tasks.filter(t => !t.completed); saveData(); renderTasks(); }

        // --- TOPIC MGMT ---
        function renderTopics() {
            const container = document.getElementById('topicsContainer'); if (!container) return; container.innerHTML = '';
            state.topics.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-darkCard p-4 rounded-lg border dark:border-slate-700 flex justify-between items-center';
                div.innerHTML = `<div><div class="font-bold dark:text-darkText">${topic.name}</div><div class="text-xs text-slate-400">${topic.subtopics.join(', ')}</div></div><button onclick="deleteTopic('${topic.name}')" class="text-red-400">üóëÔ∏è</button>`;
                container.appendChild(div);
            });
        }
        function addTopic() { const input = document.getElementById('topicInput'); if(input.value) { state.topics.push({name: input.value.toUpperCase(), subtopics: [], expanded: false}); input.value=''; saveData(); renderTopics(); populateTopicSelectors(); } }
        function addSubtopic() { const parent = document.getElementById('parentTopicSelect').value; const input = document.getElementById('subtopicInput'); if(parent && input.value) { const t = state.topics.find(x => x.name === parent); t.subtopics.push(input.value); input.value=''; saveData(); renderTopics(); populateTopicSelectors(); } }
        function deleteTopic(n) { if(confirm("Delete?")) { state.topics = state.topics.filter(t => t.name !== n); saveData(); renderTopics(); populateTopicSelectors(); } }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer'); if (!container) return;
            const filter = document.getElementById('viewTopicFilter').value; container.innerHTML = '';
            let list = state.questions; if(filter) list = list.filter(x => x.topic === filter);
            list.forEach(q => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-darkCard p-3 rounded border dark:border-slate-700 text-sm flex justify-between gap-2';
                div.innerHTML = `<span class="truncate dark:text-darkText">${q.question}</span><button onclick="deleteQuestion(${q.id})" class="text-red-400">√ó</button>`;
                container.appendChild(div);
            });
        }
        function deleteQuestion(id) { state.questions = state.questions.filter(x => x.id !== id); saveData(); updateDashboard(); renderQuestions(); }
        function clearFilteredQuestions() { const f = document.getElementById('viewTopicFilter').value; if(confirm("Delete filtered?")) { state.questions = f ? state.questions.filter(x => x.topic !== f) : []; saveData(); updateDashboard(); renderQuestions(); } }

        function selectAiStyle(s) { state.settings.aiStyle = s; saveData(); showToast("Style: " + s); }
        function selectAiLanguage(l) { state.settings.aiLang = l; saveData(); showToast("Lang: " + l); }
        function saveAiSettings() { 
            state.settings.apiKey = document.getElementById('apiKeyInput').value; 
            saveData(); 
            showToast("Settings Saved!"); 
            closeAiSettingsModal(); 
        }
        function closeAiSettingsModal() { document.getElementById('aiSettingsModal').classList.add('hidden'); }
        function openAiSettingsModal() { 
            document.getElementById('aiSettingsModal').classList.remove('hidden'); 
            if(state.settings.apiKey) document.getElementById('apiKeyInput').value = state.settings.apiKey;
        }
        function addQuestion() {
            const q = document.getElementById('questionInput').value;
            const ans = document.getElementById('correctAnswer').value;
            const topic = document.getElementById('viewTopicFilter').value || 'AREA 1';
            if(!q || ans==='') return showToast("Question and answer required", "error");
            state.questions.push({ id: Date.now(), question: q, options: [document.getElementById('optionA').value, document.getElementById('optionB').value, document.getElementById('optionC').value, document.getElementById('optionD').value], correct: parseInt(ans), topic: topic.toUpperCase(), image: document.getElementById('imageInput').value });
            saveData(); updateDashboard(); renderQuestions(); showToast("Question saved");
        }
    </script>
</body>
</html>
